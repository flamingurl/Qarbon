<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Manager Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè≠ Factory Manager Dashboard</h1>
        </header>

        <div class="manager-section">
            <h2>ü§ñ AI Auto-Assignment</h2>
            <button id="assignBtn" class="btn-primary">Assign All Available Workers</button>
        </div>

        <div class="manager-section">
            <h2>‚ûï Add New Task</h2>
            <form id="taskForm">
                <input type="text" id="desc" placeholder="What needs to be done?" required>
                <select id="urg">
                    <option value="1">Urgency 1 (Low)</option>
                    <option value="2">Urgency 2</option>
                    <option value="3" selected>Urgency 3 (Medium)</option>
                    <option value="4">Urgency 4</option>
                    <option value="5">Urgency 5 (Critical)</option>
                </select>
                <button type="submit" class="btn-primary" style="background:#6366f1">Add Task</button>
            </form>
        </div>

        <div class="manager-section">
            <h2>üìã Active Tasks</h2>
            <div id="activeTasks" class="tasks-grid"></div>
        </div>

        <div class="manager-section">
            <h2>‚úÖ Completed Tasks</h2>
            <div id="completedTasks" class="completed-list"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        async function loadTasks() {
            try {
                const res = await fetch(`${API_URL}/tasks`);
                const tasks = await res.json();
                
                const activeContainer = document.getElementById('activeTasks');
                const completeContainer = document.getElementById('completedTasks');
                
                // Separate tasks
                const active = tasks.filter(t => !t.date_completed);
                const completed = tasks.filter(t => t.date_completed);

                // Render Active Cards
                activeContainer.innerHTML = active.map(t => `
                    <div class="task-card">
                        <div class="urgency-badge" style="background:${getUrgencyColor(t.urgency)}">
                            Priority ${t.urgency}
                        </div>
                        <h3>${t.description}</h3>
                        <p>üë§ <b>${t.assigned_to || 'Waiting for AI...'}</b></p>
                        <button onclick="markComplete(${t.row_number})" class="btn-complete">Mark Done</button>
                    </div>
                `).join('');

                // Render Minimal Completed List
                completeContainer.innerHTML = completed.map(t => `
                    <div class="completed-item">
                        <span><b>‚úì</b> ${t.description} (Assigned to: ${t.assigned_to})</span>
                        <small>Completed: ${t.date_completed}</small>
                    </div>
                `).join('');

            } catch (err) { console.error("Error loading tasks:", err); }
        }

        async function markComplete(row) {
            await fetch(`${API_URL}/complete-task`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({row_number: row})
            });
            loadTasks();
        }

        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault();
            const desc = document.getElementById('desc').value;
            const urg = document.getElementById('urg').value;
            
            await fetch(`${API_URL}/add-task`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({description: desc, urgency: urg})
            });
            e.target.reset();
            loadTasks();
        };

        document.getElementById('assignBtn').onclick = async () => {
            const btn = document.getElementById('assignBtn');
            btn.innerText = "ü§ñ AI analyzing worker roles...";
            await fetch(`${API_URL}/assign-tasks`, {method: 'POST'});
            btn.innerText = "Assign All Available Workers";
            loadTasks();
        };

        function getUrgencyColor(u) {
            return ['#10b981', '#84cc16', '#f59e0b', '#f97316', '#ef4444'][u-1] || '#94a3b8';
        }

        loadTasks();
        // Refresh data every 30 seconds automatically
        setInterval(loadTasks, 30000);
    </script>
</body>
</html>
