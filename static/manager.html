<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Qarbon Aerospace Task Assignment Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Qarbon Aerospace Task Assignment Manager</h1>
        
        <div class="manager-section">
            <h2>AI Auto-Assignment (One per Person)</h2>
            <button id="assignBtn" class="btn-primary">Optimize Shift Assignments</button>
        </div>

        <div class="manager-section">
            <h2>Add Task</h2>
            <form id="taskForm">
                <input type="text" id="desc" placeholder="Task description" required>
                <input type="number" id="urg" placeholder="Urgency (1-5)" min="1" max="5" required>
                <button type="submit" class="btn-primary">Submit Task</button>
            </form>
        </div>

        <div class="manager-section">
            <h2>Active Tasks</h2>
            <div id="activeTasks" class="tasks-grid"></div>
        </div>

        <div class="manager-section">
            <h2>Registered Personnel</h2>
            <div id="workersOverview"></div>
        </div>

        <div class="manager-section">
            <h2>Completed Task Archive</h2>
            <div id="completedTasks" class="completed-list"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        async function loadData() {
            const [tRes, wRes] = await Promise.all([fetch(`${API_URL}/tasks`), fetch(`${API_URL}/workers`)]);
            const tasks = await tRes.json();
            const workers = await wRes.json();
            
            document.getElementById('activeTasks').innerHTML = tasks.filter(t => !t.date_completed).map(t => `
                <div class="task-card">
                    <button class="del-small" onclick="deleteItem('task', ${t.row_number})">X</button>
                    <h3>${t.description}</h3>
                    <p>Assignee: ${t.assigned_to || 'Unassigned'}</p>
                    <button class="btn-complete" onclick="markComplete(${t.row_number})">Complete</button>
                </div>`).join('');

            document.getElementById('completedTasks').innerHTML = tasks.filter(t => t.date_completed).map(t => `
                <div class="completed-item"><span>${t.description} (${t.assigned_to})</span><small>${t.date_completed}</small></div>`).join('');

            document.getElementById('workersOverview').innerHTML = `<table>
                <thead><tr><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
                <tbody>${workers.map(w => `
                    <tr><td>${w.name}</td><td>${w.job_title}</td>
                    <td><button onclick="assignSelf('${w.name}')" class="btn-self">Assign Task</button>
                    <button onclick="deleteItem('worker', '${w.name}')" class="del-small">Remove</button></td></tr>`).join('')}
                </tbody></table>`;
        }

        async function deleteItem(type, id) {
            await fetch(`${API_URL}/delete-${type}/${id}`, { method: 'DELETE' });
            loadData();
        }

        async function assignSelf(name) {
            await fetch(`${API_URL}/assign-self`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({worker_name: name}) 
            });
            loadData();
        }

        async function markComplete(row) {
            await fetch(`${API_URL}/complete-task`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({row_number: row}) 
            });
            loadData();
        }

        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/add-task`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({description: document.getElementById('desc').value, urgency: document.getElementById('urg').value}) 
            });
            loadData();
        };

        document.getElementById('assignBtn').onclick = async () => {
            await fetch(`${API_URL}/assign-tasks`, { method: 'POST' });
            loadData();
        };

        loadData();
    </script>
</body>
</html>
