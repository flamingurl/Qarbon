<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Qarbon Aerospace | Task Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <header>
        <div class="container">
            <h1>Qarbon Aerospace Task Management</h1>
        </div>
    </header>

    <div class="container">
        
        <div class="manager-section">
            <h2>System Controls</h2>
            <button id="assignBtn" class="btn-primary">Execute AI Optimized Shift Assignment</button>
        </div>

        <div class="form-group">
            <div class="manager-section">
                <h2>Personnel Registration</h2>
                <form id="workerForm">
                    <input type="text" id="workerName" placeholder="Worker Full Name" required>
                    <input type="text" id="workerRole" placeholder="Job Title (e.g., Lead Machinist)" required>
                    <input type="text" id="workerSchedule" placeholder="Shift (e.g. 0800-1600)" required>
                    <button type="submit" class="btn-primary" style="width:100%; background:#10b981">Register Personnel</button>
                </form>
            </div>

            <div class="manager-section">
                <h2>Task Intake</h2>
                <form id="taskForm">
                    <input type="text" id="desc" placeholder="Task Description" required>
                    <input type="number" id="urg" placeholder="Urgency (1-5)" min="1" max="5" required>
                    <button type="submit" class="btn-primary" style="width:100%">Log New Task</button>
                </form>
            </div>
        </div>

        <div class="manager-section">
            <h2>Live Operational Tasks</h2>
            <div id="activeTasks" class="tasks-grid"></div>
        </div>

        <div class="manager-section">
            <h2>Active Personnel Directory</h2>
            <div id="workersOverview"></div>
        </div>

        <div class="manager-section">
            <h2>Completed Task Archive (EST)</h2>
            <div id="completedTasks"></div>
        </div>

    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        async function loadData() {
            const [tRes, wRes] = await Promise.all([fetch(`${API_URL}/tasks`), fetch(`${API_URL}/workers`)]);
            const tasks = await tRes.json();
            const workers = await wRes.json();
            
            // 1. Render Active Tasks
            const active = tasks.filter(t => !t.date_completed);
            document.getElementById('activeTasks').innerHTML = active.map(t => `
                <div class="task-card">
                    <button class="del-small" onclick="deleteItem('task', ${t.row_number})">Delete</button>
                    <span class="urgency-indicator" style="color:${getUrgencyColor(t.urgency)}">Priority ${t.urgency}</span>
                    <h3 style="margin: 0.5rem 0">${t.description}</h3>
                    <p style="font-size:0.85rem; color:#64748b">Assigned: <b>${t.assigned_to || 'Pending'}</b></p>
                    <button class="btn-complete" onclick="markComplete(${t.row_number})">Mark as Completed</button>
                </div>`).join('');

            // 2. Render Archive
            document.getElementById('completedTasks').innerHTML = tasks.filter(t => t.date_completed).map(t => `
                <div class="completed-item">
                    <span><b>FINISHED:</b> ${t.description} (${t.assigned_to})</span>
                    <small>${t.date_completed} EST</small>
                </div>`).join('');

            // 3. Render Worker Table with Status Tracking
            const assignedNames = new Set(active.map(t => t.assigned_to).filter(name => name));

            document.getElementById('workersOverview').innerHTML = `<table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${workers.map(w => {
                    const isAssigned = assignedNames.has(w.name);
                    return `
                    <tr>
                        <td><b>${w.name}</b></td>
                        <td>${w.job_title}</td>
                        <td>
                            <span class="status-badge ${isAssigned ? 'status-assigned' : 'status-unassigned'}">
                                ${isAssigned ? 'ASSIGNED' : 'UNASSIGNED'}
                            </span>
                        </td>
                        <td>
                            <button onclick="assignSelf('${w.name}')" class="btn-self">ASSIGN NEXT</button>
                            <button onclick="deleteItem('worker', '${w.name}')" class="del-btn-table">REMOVE</button>
                        </td>
                    </tr>`;
                }).join('')}
                </tbody></table>`;
        }

        async function deleteItem(type, id) {
            if(!confirm(`Confirm deletion of ${type}?`)) return;
            await fetch(`${API_URL}/delete-${type}/${id}`, { method: 'DELETE' });
            loadData();
        }

        async function assignSelf(name) {
            await fetch(`${API_URL}/assign-self`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({worker_name: name}) 
            });
            loadData();
        }

        async function markComplete(row) {
            await fetch(`${API_URL}/complete-task`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({row_number: row}) 
            });
            loadData();
        }

        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/add-task`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({description: document.getElementById('desc').value, urgency: document.getElementById('urg').value}) 
            });
            e.target.reset();
            loadData();
        };

        document.getElementById('workerForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/add-worker`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({
                    name: document.getElementById('workerName').value,
                    job_title: document.getElementById('workerRole').value,
                    date_working: document.getElementById('workerSchedule').value
                }) 
            });
            e.target.reset();
            loadData();
        };

        document.getElementById('assignBtn').onclick = async () => {
            const btn = document.getElementById('assignBtn');
            btn.innerText = "AI OPTIMIZING...";
            await fetch(`${API_URL}/assign-tasks`, { method: 'POST' });
            btn.innerText = "EXECUTE AI OPTIMIZED SHIFT ASSIGNMENT";
            loadData();
        }

        function getUrgencyColor(u) {
            return ['#10b981', '#84cc16', '#f59e0b', '#f97316', '#ef4444'][u-1];
        }

        loadData();
    </script>
</body>
</html>
